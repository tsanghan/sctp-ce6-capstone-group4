name: Now I am become Death, the Destroyer of Worlds

on:
  workflow_dispatch:
      inputs:
        cluster_name:
          required: true
          type: string

jobs:
  Destroy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4.0.2
      with:
        aws-region: ${{ vars.AWS_REGION }}
        role-to-assume: ${{ vars.ROLE_TO_ASSUME }}
        role-session-name: ${{ vars.ROLE_SESSION_NAME }}

    - name: STS Get-Caller-Identity
      run: |
          aws sts get-caller-identity

    - name: Install kubectl
      uses: tsanghan/setup-kubectl-action@main
      with:
        version: '1.31.1'

    - name: Destroy Gateway & HTTPRoute resources
      run: |
        test -d ~/.kube || mkdir ~/.kube
        aws eks update-kubeconfig --region ${{ vars.AWS_REGION }} --name ${{ inputs.cluster_name }}
        echo $(kubectl -n demoapp-gw get gateway -o=name) | xargs -I% kubectl delete -n demoapp-gw %
        sleep 30

    - name: Setup Tofu
      uses: opentofu/setup-opentofu@v1
      with:
        tofu_version: "1.7.3"
        tofu_wrapper: false

    - name: Tofu Init
      run: |
        cd aws-infra
        tofu init

    - name: Tofu Destroy
      env:
        TF_VAR_MYIP: ${{ vars.TF_VAR_MYIP }}
      run: |
        cd aws-infra
        tofu destroy -auto-approve